<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.55">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Lucas S. Macoris (FGV-EAESP)">

<title>Data Case I - Investing in the Pharmaceutical Industry ‚Äì Lucas S. Macoris</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-87FLN5SXEJ"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-87FLN5SXEJ', { 'anonymize_ip': true});
</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Lucas S. Macoris</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://lsmacoris.github.io/"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../index.html"> 
<span class="menu-text">Overview</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../fin-mgmt.html"> 
<span class="menu-text">Financial Management</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../fin-strat.html"> 
<span class="menu-text">Financial Strategy</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../quant-fin.html"> 
<span class="menu-text">Quantitative Finance</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/lsmacoris"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:lucasmacoris@gmail.com"> <i class="bi bi-envelope" role="img" aria-label="Email">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/lucas-macoris-390a47160/"> <i class="bi bi-linkedin" role="img" aria-label="LinkedIn">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://drive.google.com/file/d/184m-BDeB-31SSyEuzqINco2UzqRFXhma/view?usp=drive_link"> <i class="bi bi-file-pdf" role="img" aria-label="CV">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content column-page" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Data Case I - Investing in the Pharmaceutical Industry</h1>
</div>



<div class="quarto-title-meta column-page">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Lucas S. Macoris (FGV-EAESP) </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="about" class="level1">
<h1>About</h1>
<p>This Data Case is part of the <em>Practical Applications in Quantitative Finance</em> course, held at FGV-EAESP‚Äôs undergraduate course in business. Carefully follow the instructions contained in the data case as well as <em>eClass¬Æ</em> before you make your submission.</p>
<section id="case-outline" class="level2">
<h2 class="anchored" data-anchor-id="case-outline">Case Outline</h2>
<p>The pharmaceutical industry is a critical sector in financial markets, influenced by regulatory approvals, drug developments, and global health events. In this first <em>Data Case</em>, you will analyze stock performance for a set of 10 pharmaceutical companies over time, applying the <code>tidyverse</code> and <code>tidyquant</code> packages to extract and interpret insights from the data.</p>
<p>You are a junior analyst at Atlas Capital, a leading buyside investment firm specializing in sector-focused strategies. The firm is considering increasing its exposure to the pharmaceutical industry, given its long-term growth potential and resilience in volatile markets. In the latest investment committee meeting, your fund manager raised an important question: <em>‚ÄúHow has the pharmaceutical industry performed over time? We need to identify whether now is the right time to increase our position.‚Äù</em></p>
<p>Your team has been tasked with conducting an in-depth financial analysis of the pharmaceutical sector. The goal is to assess industry-wide trends, identify risks and opportunities, and ultimately recommend an investment stance. More specifically, your task will involve:</p>
<ul>
<li>Collecting stock price data and compute returns</li>
<li>Visualizing key trends in returns and volatility</li>
<li>Interpreting findings and suggest investment insights</li>
</ul>
<p>To streamline our research, you will focus on the 10 largest publicly traded pharmaceutical companies in the U.S, analyze their performance, risks, and potential catalysts that could drive returns in the near future. As of February 2025, the 10 largest pharmaceutical companies traded in the U.S., along with their ticker symbols, are:</p>
<ol type="1">
<li><strong>Eli Lilly and Co.&nbsp;(LLY)</strong>: A leading pharmaceutical company known for its innovative treatments in diabetes and oncology.</li>
<li><strong>Novo Nordisk A/S (NVO)</strong>: Specializing in diabetes care, Novo Nordisk has a significant presence in the U.S. market.</li>
<li><strong>Johnson &amp; Johnson (JNJ)</strong>: A diversified healthcare company with a strong pharmaceutical division.</li>
<li><strong>AbbVie Inc.&nbsp;(ABBV)</strong>: Known for its immunology and oncology products, AbbVie is a major player in the pharmaceutical industry.</li>
<li><strong>Merck &amp; Co., Inc.&nbsp;(MRK)</strong>: Merck offers a wide range of prescription medicines, vaccines, and therapies.</li>
<li><strong>Pfizer Inc.&nbsp;(PFE)</strong>: A global pharmaceutical corporation recognized for its vaccines and therapeutics.</li>
<li><strong>Bristol-Myers Squibb Company (BMY)</strong>: Focused on oncology, cardiovascular, and immunology, Bristol-Myers Squibb is a key industry player.</li>
<li><strong>AstraZeneca PLC (AZN)</strong>: A biopharmaceutical company with a strong portfolio in oncology and respiratory diseases.</li>
<li><strong>Amgen Inc.&nbsp;(AMGN)</strong>: Specializing in biotechnology, Amgen develops therapies for serious illnesses.</li>
<li><strong>Gilead Sciences, Inc.&nbsp;(GILD)</strong>: Known for its antiviral drugs, Gilead has a significant market presence.</li>
</ol>
<p>Now, it‚Äôs up to you and your team to dive into the data, extract key insights, and present your data-driven investment thesis. Good luck‚Äîyour next career milestone at Atlas Capital depends on it. üöÄ</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Deliverable
</div>
</div>
<div class="callout-body-container callout-body">
<p>Each group is expected to deliver a single assignment. A submission must be either an <code>.R</code> script or a <code>.qmd</code> (Quarto) file, <strong>ensuring that both code and interpretations of the results are clearly presented</strong>. Whenever applicable, include concise explanations alongside your code to demonstrate your understanding of the analysis. The due date for this submission is specified on <em>eClass¬Æ</em>, so please check the platform for details. You are required to clearly document your workflow and assumptions, and provide meaningful explanations alongside your outputs.</p>
<p>To help you structure your submission, I have provided a Quarto mock template, which is already available for you to use. This template is designed to help you seamlessly integrate your code and analysis, ensuring a clear and organized presentation of your work. Feel free to use it as a starting point to format your responses effectively. The mock template can be found in the <em>Data Cases</em> folder on <em>eClass¬Æ</em>.</p>
</div>
</div>
</section>
<section id="tech-setup" class="level2">
<h2 class="anchored" data-anchor-id="tech-setup">Tech-setup</h2>
<p>Before you start, make sure that you have your <code>R</code> session correctly configured with all the following packages by running the code below:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Package names</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>packages <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"tidyverse"</span>,<span class="st">"tidyquant"</span>,<span class="st">"tidymodels"</span>,<span class="st">"xts"</span>, <span class="st">"glue"</span>,<span class="st">"scales"</span>, <span class="st">"ggthemes"</span>,<span class="st">"ggcorrplot"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Install packages not yet installed</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>installed_packages <span class="ot">&lt;-</span> packages <span class="sc">%in%</span> <span class="fu">rownames</span>(<span class="fu">installed.packages</span>())</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">any</span>(installed_packages <span class="sc">==</span> <span class="cn">FALSE</span>)) {</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(packages[<span class="sc">!</span>installed_packages])</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Load all packages</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">invisible</span>(<span class="fu">lapply</span>(packages, library, <span class="at">character.only =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Alternatively, you can simply call:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Install if not already available</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">'tidyverse'</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">'tidyquant'</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">'glue'</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">'scales'</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">'ggthemes'</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">#Load</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(tidyverse)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(tidyquant)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(tidymodels)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(glue)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(scales)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(ggthemes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="exercise-1" class="level2">
<h2 class="anchored" data-anchor-id="exercise-1">Exercise 1</h2>
<p>Use the <code>tq_get()</code> function from the <code>tidyquant</code> package to retrieve historical adjusted closing prices for the 10 largest publicly traded pharmaceutical companies in the U.S. from <em>Yahoo! Finance</em>. Your dataset should cover the period from <em>January 1, 2020</em>, to <em>December 31, 2024</em>. Using the functions from the <code>tidyverse</code>, ensure that your data includes only the timestamp column, as well as the column that contains the daily adjusted stock price information. Store this into an object called <code>financial_data</code> (or something similar). Store this data set for all the subsequent analysis - make sure not to override this dataset as you move along the data case to make sure you are always referring to the raw data pull!</p>
</section>
<section id="exercise-2" class="level2">
<h2 class="anchored" data-anchor-id="exercise-2">Exercise 2</h2>
<p>Using the <code>tidyquant</code> package, use the object you‚Äôve just created with the <code>tq_transmute</code> function to compute the yearly returns for each stock over the analysis period. More specifically, pass the <code>yearlyReturn</code> function to adjusted column using the <code>tq_transmute</code>, labeling this new variable as <code>yearly_return</code>. Arrange your dataset by year and in descending order of <code>yearly_return</code> (highest-to-lowest). Store this into a new object called, for example, <code>yearly_returns</code>. Which stock had the highest return in 2024, and which one had the lowest? Prompt the results in your session.</p>
</section>
<section id="exercise-3" class="level2">
<h2 class="anchored" data-anchor-id="exercise-3">Exercise 3</h2>
<p>With your <code>data.frame</code> containing the yearly returns over time for each stock, use <code>ggplot</code> to create a line chart of the historical cumulative returns for each stock during the study period. Which stock had the highest cumulative return up-to-date? Recall that cumulative returns can be calculated from period returns as:</p>
<p><span class="math display">\[
\text{Cumulative Return}= (1+R_1)\times(1+R_2)\times ... \times(1+R_T)-1\equiv \prod (1+R_t)-1
\]</span></p>
<p>Your chart should map <code>date</code> to the x-axis, the yearly return variable to the <code>y</code> axis, and group the results by <code>symbol</code>. To make sure that you are plotting a line chart, use the <code>geom_line()</code> function after you have mapped your data. In addition to these two layers, add any customizations that you believe that are beneficial to convey the message - see the Data Visualization</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Hint
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>With the <code>data.frame</code> you created to store yearly returns, group by <code>symbol</code>, and use <code>tq_transmute()</code> to apply the <code>Return.cumulative</code> function to the data.</li>
<li>Now, your resulting <code>data.frame</code> contains the cumulative returns for all stocks. You can adjust the column names with the <code>setNames()</code> function and pipe that into a <code>ggplot</code> call, mapping the <code>symbol</code> to the x-axis, the cumulative return column to the y-axis, and the <code>geom_col()</code> function to create a bar chart. Add as many customizations you think are worth the effort.</li>
</ol>
</div>
</div>
</section>
<section id="exercise-4" class="level2">
<h2 class="anchored" data-anchor-id="exercise-4">Exercise 4</h2>
<p>After reviewing your initial analysis, your fund manager at <em>Atlas Capital</em> liked the idea of examining yearly returns to get a broader perspective on performance. However, they pointed out that pharmaceutical companies vary significantly in terms of risk exposure, so it‚Äôs crucial to account for volatility as well. To complement the analysis, use the same rationale from the previous exercise to calculate the yearly volatility for each stock. How do the risk levels differ between firms? Store your results in a new object and prompt it in your session.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Hint
</div>
</div>
<div class="callout-body-container callout-body">
<p>As opposed to the <code>yearlyReturn</code> function, the <code>tidyquant</code> package does not have a pre-built <code>dailyStdev</code> function. Instead, what you can do is to use a combination of functions to get the expected result:</p>
<ol type="1">
<li>First, use <code>tq_transmute()</code> to calculate daily returns passing the <code>dailyReturn</code> function</li>
<li>Now, your resulting <code>data.frame</code> contains daily returns for all stocks. It is now in a convenient format to chain this object again, in another <code>tq_transmute()</code> function, applying the <code>StdDev.annualized</code> function and assign to a new object, like <code>yearly_volatility</code>. Note, however, that if you simply use <code>StdDev.annualized</code>, it will calculate an annualized metric for each stock for the whole period, which is not what you want.</li>
</ol>
<p>To make sure that you have calculating the annualized standard deviation for each year, you can do a composition of <code>apply.yearly</code>, which applies a given function at yearly intervals, and <code>StdDev.annualized</code>, using the following syntax:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>your_daily_return_object<span class="sc">%&gt;%</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tq_transmute</span>(<span class="at">select =</span> daily_return,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">mutate_fun =</span> apply.yearly,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">FUN=</span>StdDev.annualized,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">col_rename =</span> <span class="st">'yearly_volatility'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here, <code>tq_transmute()</code> will apply the function defined in <code>FUN</code> over each interval.</p>
</div>
</div>
</section>
<section id="exercise-5" class="level2">
<h2 class="anchored" data-anchor-id="exercise-5">Exercise 5</h2>
<p>Building on your previous findings, since some companies exhibit higher returns but also greater risk, it might be a good idea to add a risk-adjusted performance metric to the analysis. The <em>Sharpe ratio</em> for stock <span class="math inline">\(i\)</span> in period <span class="math inline">\(t\)</span> measures the risk-adjusted return of an asset and is calculated as:</p>
<p><span class="math display">\[
\text{Sharpe Ratio}_{i,t}=\dfrac{R_{i,t}-R_{f,t}}{\sigma_{i,t}},
\]</span></p>
<p>where <span class="math inline">\(R_{i,t}\)</span> is the return of a given stock <span class="math inline">\(i\)</span> in period <span class="math inline">\(t\)</span>, <span class="math inline">\(R_{f,t}\)</span> is the risk-free return for the same period, and <span class="math inline">\(\sigma_{i,t}\)</span> is the volatility for stock <span class="math inline">\(i\)</span> in period <span class="math inline">\(t\)</span>.</p>
<p>Your task is to calculate the <em>Sharpe Ratio</em> for each pharmaceutical stock using yearly returns and yearly volatility. To simplify your calculations, assume a risk-free rate of <span class="math inline">\(0\%\)</span> per year (<em>i.e</em>, no risk-free premium). Compare the Sharpe ratios across companies. Do the highest-return stocks also have the best risk-adjusted performance? Are there any stocks that stand out as particularly efficient in generating returns relative to their risk? Are there companies that deliver strong returns but with disproportionately high volatility?</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Hint
</div>
</div>
<div class="callout-body-container callout-body">
<p>There are two ways you can use to create the <em>Sharpe Ratio</em>:</p>
<ol type="1">
<li><p>Using the previously created <code>yearly_returns</code> and <code>yearly_volatility</code> objects, use the <code>left_join()</code> function to merge them based on a common set of identifiers (in this case, <code>date</code> and <code>symbol</code>). After that, manipulate the resulting <code>data.frame</code> with <code>mutate</code> to generate the <em>Sharpe Ratio</em>.</p></li>
<li><p>Using <code>tq_transmute</code> in a very similar fashion to what you have done to calculate the yearly volatility, but now passing the the <code>SharpeRatio.annualized</code> function with arguments <code>Rf=0</code> and <code>scale=252</code>.</p></li>
</ol>
<p>Although both approaches should yield similar results, potential differences might stem from rounding.</p>
</div>
</div>
</section>
<section id="exercise-6" class="level2">
<h2 class="anchored" data-anchor-id="exercise-6">Exercise 6</h2>
<p>Way to go! As you delve deeper into your investment analysis, your fund manager emphasizes the importance of understanding how different pharmaceutical stocks interact with one another over time. To gain insights into the relationships between these companies, your next task is to calculate the correlation of daily stock returns for the selected pharmaceutical companies for the analysis period.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Hint
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>First, start by calculating the daily returns for each stock. You can use the <code>tq_transmute</code> function into your dataset and apply the <code>dailyReturn</code> function.</li>
<li>After that, you need to pivot your data in such a way that each column is a specific ticker with information on daily returns. You can do that by calling <code>pivot_wider(names_from='symbol',values_from='daily_return')</code>, assuming that your daily return variable is called <code>daily_return</code>.</li>
<li>With that, you‚Äôll achieve a data frame that now has <span class="math inline">\(11\)</span> columns, namely, the <code>date</code> and the <span class="math inline">\(10\)</span> individual ticker columns with daily return information.</li>
<li>To make sure that you are calculating the correlation using a <span class="math inline">\(10\times10\)</span> matrix, use <code>select(-date)</code> to get rid of the date column and pipe that into <code>cor()</code>, which calculates the correlation across all pairs of variables within a <code>data.frame</code>, and outputs a correlation matrix.</li>
</ol>
<p>If you want, you can pipe the result into <code>ggcorplot()</code>, a function from the <code>ggcorplot</code> package that provides meaningful visualizations of correlation matrices.</p>
</div>
</div>
</section>
<section id="exercise-7" class="level2">
<h2 class="anchored" data-anchor-id="exercise-7">Exercise 7</h2>
<p>Based on your analysis of the correlation between each stock, it seems that these pharmaceutical firms are relatively trending together. Notwithstanding, there might be gains from diversification if instead of choosing a specific firm, we decide to hold a portfolio of pharmaceutical stocks.</p>
<p>Investing in a single stock exposes an investor to company-specific (idiosyncratic) risk, such as lawsuits, failed drug trials, or regulatory changes. However, constructing a diversified portfolio of multiple stocks within the same industry can help smooth out these risks while still capturing the overall sector trends. For instance, while one pharmaceutical company may experience a stock price drop due to a failed drug trial, another might gain due to a successful FDA approval. By equally weighting multiple stocks, investors can reduce the impact of any single company‚Äôs negative performance while still benefiting from the broader industry‚Äôs growth.</p>
<p>Your manager liked your idea and wanted to test it out by creating an <em>equally-weighted</em> portfolio of all pharmaceutical companies over time. Using the <code>tq_transmute()</code> function, create an object, <code>portfolio_returns</code>, that contains the yearly returns of a portfolio that assigns equal weights - in this case, 10% - on each stock, and compare that to the yearly returns of the <em>S&amp;P 500</em> Index. Would the fund manager be better-off by investing in the portfolio relative to the <em>S&amp;P500</em>?</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Hint
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>First, start by calculating the yearly returns for each stock using the <code>tq_transmute()</code> function as before, grouping the data by <code>symbol</code> and creating a new variable, <code>yearly_return</code>.</li>
<li>Knowing that you have an equally-weighted portfolio, group your data my <code>date</code> and pipe the result into a <code>summarize()</code> function to create a new variable, <code>portfolio_return</code> as the average across all stocks. Assign this result to an object called <code>portfolio_returns</code></li>
<li>Fetch <em>S&amp;P 500</em> data using a similar call to <code>tq_get()</code> like you did in the beginning of the exercise, but now collecting data for <code>^GSPC</code>. Calculate the yearly returns and assign to a new variable, <code>index_return</code>. Store the result in another <code>data.frame</code>, <code>index_returns</code>.</li>
<li>Merge both datasets using <code>left_join()</code>.</li>
</ol>
</div>
</div>
</section>
<section id="exercise-8" class="level2">
<h2 class="anchored" data-anchor-id="exercise-8">Exercise 8</h2>
<p>After analyzing the equally weighted pharmaceutical portfolio, the fund manager was impressed with the performance results. However, they remain skeptical about whether the portfolio truly provides better risk-adjusted returns compared to simply picking one of the best-performing stocks in the industry.</p>
<p>As final step, your job is to prove whether the portfolio offers superior risk-adjusted returns by computing the <em>Sharpe Ratio</em> for both the portfolio and its individual stocks in 2024. If the portfolio has a higher Sharpe ratio, it means that diversification helps maximize returns while controlling for risk ‚Äî an essential argument when managing institutional funds.</p>
<p>In order to do that, your task is to provide a visualization of the <em>Sharpe Ratio</em> of the equally-weighted portfolio you‚Äôve just created and compare that to those of the individual stocks. I have already created the portfolio results for you, so you can copy-paste that to your session:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>portfolio_sharpe<span class="ot">=</span><span class="fu">data.frame</span>(<span class="at">symbol=</span><span class="st">'Portfolio'</span>,</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>                            <span class="at">yearly_return=</span><span class="fl">0.03705213</span>,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>                            <span class="at">yearly_volatility=</span><span class="fl">0.1223983</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Hint
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Create the <code>portfolio_sharpe</code> in your session using the code chunk above.</li>
<li>Using the <code>yearly_returns</code> object you‚Äôve created in Exercise 2, filter by <code>year(date)==2024</code> and <code>left_join()</code> with the <code>yearly_volatility</code> object you have created in Exercise 3, assigning the result to a new object</li>
<li>Finally, bind <code>portfolio_sharpe</code> to the resulting <code>data.frame</code> in a rowwise manner using <code>rbind(dataframe1,dataframe2)</code></li>
<li>Finally, call <code>ggplot()</code> and adjust the aesthetics to show the relationship between risk (x-axis) and return (y-axis) for all individual stocks and the portfolio.</li>
</ol>
</div>
</div>
</section>
<section id="wrapping-up-your-analysis" class="level2">
<h2 class="anchored" data-anchor-id="wrapping-up-your-analysis">Wrapping-up your analysis</h2>
<p>Now that you have analyzed the Sharpe ratios of both individual pharmaceutical stocks and the equally weighted portfolio, take a step back and summarize your insights. Did the portfolio offer a better risk-adjusted return compared to individual stocks? If so, why? If not, what might explain the results?</p>
<p>Based on your findings, what would you recommend to the fund manager? Would you suggest investing in the diversified portfolio, or do certain individual stocks offer superior risk-adjusted returns? Would you propose an alternative weighting scheme, such as a market cap-weighted portfolio, to further improve performance?</p>
<p>Write a short conclusion summarizing your key takeaways and justify your investment recommendation using data-driven insights.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/lsmacoris\.github\.io\/lectures");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Copyright 2025, Lucas Macoris. Photography by <a href="https://www.jurizieri.com.br/">Juliana Rizieri</a>.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions"><ul><li><a href="https://github.com/lsmacoris/lectures/edit/main/quant-fin/datacases/data-case-1/data-case-1.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/lsmacoris/lectures/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
<p>Built with <a href="https://quarto.org/">Quarto</a></p>
</div>
  </div>
</footer>




</body></html>